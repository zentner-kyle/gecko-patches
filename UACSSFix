# HG changeset patch
# User Kyle Zentner <kzentner@mozilla.com>
# Parent  31856aca0b5d75da5291803bb76a49054e392c44

diff --git a/layout/reftests/w3c-css/submitted/contain/contain-layout-inline-block-003.html b/layout/reftests/w3c-css/submitted/contain/contain-layout-inline-block-003.html
--- a/layout/reftests/w3c-css/submitted/contain/contain-layout-inline-block-003.html
+++ b/layout/reftests/w3c-css/submitted/contain/contain-layout-inline-block-003.html
@@ -8,17 +8,17 @@
   <link rel="help" href="http://www.w3.org/TR/css-containment-1/#containment-layout">
   <link rel="match" href="contain-layout-inline-block-003-ref.html">
   <style>
   body {
     margin: 0;
   }
   .container {
     display: inline-block;
-    contain: layout !important;
+    contain: layout;
     overflow: hidden;
     background: red;
     border: 8px solid green;
     margin: 2px;
   }
 
   .right-float {
     float: right;
@@ -61,20 +61,16 @@
 <body>
   <!--
     Since the contents of a contained element do not move the baseline, all
     of the following green boxes should be on the same line, and the same size.
     All of the words should be on the same line as each other as well.
   -->
   <div class="container"></div>
   Word
-  <script>
-    var c = document.getElementsByClassName('container')[0];
-    document.write(getComputedStyle(c).contain);
-  </script>
   <div class="container">Test text contents.</div>
   Word
   <div class="container"><div><div class="right-float"></div></div></div>
   Word
   <div class="container"><div><div class="left-float"></div></div></div>
   Word
   <div class="container"><div class="block"></div></div>
   Word
diff --git a/layout/style/nsLayoutStylesheetCache.cpp b/layout/style/nsLayoutStylesheetCache.cpp
--- a/layout/style/nsLayoutStylesheetCache.cpp
+++ b/layout/style/nsLayoutStylesheetCache.cpp
@@ -387,16 +387,18 @@ nsLayoutStylesheetCache::EnsureGlobal()
                                true);
 
   // For each pref that controls a CSS feature that a UA style sheet depends
   // on (such as a pref that enables a property that a UA style sheet uses),
   // register DependentPrefChanged as a callback to ensure that the relevant
   // style sheets will be re-parsed.
   Preferences::RegisterCallback(&DependentPrefChanged,
                                 "layout.css.ruby.enabled");
+  Preferences::RegisterCallback(&DependentPrefChanged,
+                                "layout.css.contain.enabled");
 }
 
 void
 nsLayoutStylesheetCache::InitFromProfile()
 {
   nsCOMPtr<nsIXULRuntime> appInfo = do_GetService("@mozilla.org/xre/app-info;1");
   if (appInfo) {
     bool inSafeMode = false;
diff --git a/layout/style/ua.css b/layout/style/ua.css
--- a/layout/style/ua.css
+++ b/layout/style/ua.css
@@ -149,22 +149,21 @@
   float: none ! important;
   -moz-box-ordinal-group: inherit !important;
   text-overflow: inherit;
   overflow-clip-box: inherit;
 }
 
 *|*::-moz-scrolled-content, *|*::-moz-scrolled-canvas,
 *|*::-moz-scrolled-page-sequence {
+  contain: inherit;
   /* e.g., text inputs, select boxes */
   padding: inherit;
   /* The display doesn't affect the kind of frame constructed here.  This just
      affects auto-width sizing of the block we create. */
-  contain: layout !important;
-  background: green;
   display: block;
   -moz-box-orient: inherit;
   /* make unicode-bidi inherit, otherwise it has no effect on text inputs and
      blocks with overflow: scroll; */
   unicode-bidi: inherit;
   text-overflow: inherit;
   -moz-column-count: inherit;
   -moz-column-width: inherit;
diff --git a/layout/tools/reftest/reftest-preferences.js b/layout/tools/reftest/reftest-preferences.js
--- a/layout/tools/reftest/reftest-preferences.js
+++ b/layout/tools/reftest/reftest-preferences.js
@@ -1,9 +1,9 @@
-if (false) {
+    branch.setBoolPref("layout.css.contain.enabled", true);
     // For mochitests, we're more interested in testing the behavior of in-
     // content XBL bindings, so we set this pref to true. In reftests, we're
     // more interested in testing the behavior of XBL as it works in chrome,
     // so we want this pref to be false.
     branch.setBoolPref("dom.use_xbl_scopes_for_remote_xul", false);
     branch.setIntPref("gfx.color_management.mode", 2);
     branch.setBoolPref("gfx.color_management.force_srgb", true);
     branch.setBoolPref("browser.dom.window.dump.enabled", true);
@@ -66,9 +66,8 @@ if (false) {
     // Make sure SelfSupport doesn't hit the network.
     branch.setCharPref("browser.selfsupport.url", "https://%(server)s/selfsupport-dummy/");
 
     // Disable periodic updates of service workers.
     branch.setBoolPref("dom.serviceWorkers.periodic-updates.enabled", false);
 
     // Allow XUL and XBL files to be opened from file:// URIs
     branch.setBoolPref("dom.allow_XUL_XBL_for_file", true);
-}
