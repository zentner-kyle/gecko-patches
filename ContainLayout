# HG changeset patch
# User Kyle Zentner <kzentner@mozilla.com>
# Parent  aca1404277c999e0f2ed11c681dd47c985c5af1d

diff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp
+++ b/layout/base/nsCSSFrameConstructor.cpp
@@ -32,16 +32,17 @@
 #include "nsPresShell.h"
 #include "nsIPresShell.h"
 #include "nsUnicharUtils.h"
 #include "nsStyleSet.h"
 #include "nsViewManager.h"
 #include "nsStyleConsts.h"
 #include "nsIDOMXULElement.h"
 #include "nsContainerFrame.h"
+#include "nsContainmentFrame.h"
 #include "nsNameSpaceManager.h"
 #include "nsIComboboxControlFrame.h"
 #include "nsIListControlFrame.h"
 #include "nsIDOMCharacterData.h"
 #include "nsPlaceholderFrame.h"
 #include "nsTableRowGroupFrame.h"
 #include "nsIFormControl.h"
 #include "nsCSSAnonBoxes.h"
@@ -1205,17 +1206,17 @@ nsFrameConstructorState::AddChild(nsIFra
                                                        aStyleContext,
                                                        aParentFrame,
                                                        nullptr,
                                                        placeholderType);
 
     placeholderFrame->AddStateBits(mAdditionalStateBits);
     // Add the placeholder frame to the flow
     aFrameItems.AddChild(placeholderFrame);
-  }
+  } 
 #ifdef DEBUG
   else {
     NS_ASSERTION(aNewFrame->GetParent() == aParentFrame,
                  "In-flow frame has wrong parent");
   }
 #endif
 
   if (aInsertAfter) {
@@ -3745,21 +3746,32 @@ nsCSSFrameConstructor::ConstructFrameFro
     ancestorPusher.PushStyleScope(content);
   }
 
   nsIFrame* newFrame;
   nsIFrame* primaryFrame;
   nsStyleContext* const styleContext = aItem.mStyleContext;
   const nsStyleDisplay* display = styleContext->StyleDisplay();
   if (bits & FCDATA_FUNC_IS_FULL_CTOR) {
+    nsContainerFrame *container = nullptr;
+    nsRefPtr<nsStyleContext> scrolledContentStyle = nullptr;
+    bool contained = display->IsLayoutContaining();
+    nsFrameItems containedFrameItems;
+    if (contained) {
+      scrolledContentStyle = BeginBuildingContainment(aState, content,
+          styleContext, aParentFrame, container);
+      aParentFrame = container;
+    }
     newFrame =
       (this->*(data->mFullConstructor))(aState, aItem, aParentFrame,
                                         display, aFrameItems);
-    MOZ_ASSERT(newFrame, "Full constructor failed");
     primaryFrame = newFrame;
+    if (contained) {
+      FinishBuildingContainment(container, newFrame, scrolledContentStyle);
+    }
   } else {
     newFrame =
       (*data->mFunc.mCreationFunc)(mPresShell, styleContext);
 
     bool allowOutOfFlow = !(bits & FCDATA_DISALLOW_OUT_OF_FLOW);
     bool isPopup = aItem.mIsPopup;
     NS_ASSERTION(!isPopup ||
                  (aState.mPopupItems.containingBlock &&
@@ -3769,16 +3781,23 @@ nsCSSFrameConstructor::ConstructFrameFro
 
     nsContainerFrame* geometricParent =
       isPopup ? aState.mPopupItems.containingBlock :
       (allowOutOfFlow ? aState.GetGeometricParent(display, aParentFrame)
                       : aParentFrame);
 
     // Must init frameToAddToList to null, since it's inout
     nsIFrame* frameToAddToList = nullptr;
+    if (display->IsLayoutContaining()) {
+      printf("CONTAIN: IsLayoutContaining() -> true\n");
+      nsContainerFrame* containmentFrame = nullptr;
+      BuildContainment(aState, content, styleContext, newFrame,
+                       geometricParent, containmentFrame);
+      newFrame = containmentFrame;
+    }
     if ((bits & FCDATA_MAY_NEED_SCROLLFRAME) &&
         display->IsScrollableOverflow()) {
       nsContainerFrame* scrollframe = nullptr;
       BuildScrollFrame(aState, content, styleContext, newFrame,
                        geometricParent, scrollframe);
       frameToAddToList = scrollframe;
     } else {
       InitAndRestoreFrame(aState, content, geometricParent, newFrame);
@@ -4442,16 +4461,54 @@ nsCSSFrameConstructor::BeginBuildingScro
 
   if (gfxScrollFrame) {
      gfxScrollFrame->SetInitialChildList(kPrincipalList, anonymousItems);
   }
 
   return scrolledChildStyle.forget();
 }
 
+already_AddRefed<nsStyleContext>
+nsCSSFrameConstructor::BeginBuildingContainment(nsFrameConstructorState& aState,
+                                                nsIContent*              aContent,
+                                                nsStyleContext*          aContentStyle,
+                                                nsContainerFrame*        aParentFrame,
+                                                nsContainerFrame*&       aNewFrame)
+{
+  nsFrameItems anonymousItems;
+
+  nsRefPtr<nsStyleContext> contentStyle = aContentStyle;
+
+  if (!aNewFrame) {
+    aNewFrame = new (mPresShell)
+      nsContainmentFrame(contentStyle);
+    InitAndRestoreFrame(aState, aContent, aParentFrame, aNewFrame);
+  }
+
+  CreateAnonymousFrames(aState, aContent, aNewFrame, nullptr,
+                        anonymousItems);
+
+  nsStyleSet *styleSet = mPresShell->StyleSet();
+  nsRefPtr<nsStyleContext> containedChildStyle =
+    styleSet->ResolveAnonymousBoxStyle(nsCSSAnonBoxes::containment, contentStyle);
+
+  aNewFrame->SetInitialChildList(kPrincipalList, anonymousItems);
+  return containedChildStyle.forget();
+}
+
+void
+nsCSSFrameConstructor::FinishBuildingContainment(nsContainerFrame* aContainmentFrame,
+                                                 nsIFrame *aContainedFrame,
+                                                 nsRefPtr<nsStyleContext> &aContainedChildStyle)
+{
+  //aContainedFrame->SetStyleContextWithoutNotification(aContainedChildStyle);
+  nsFrameList contained(aContainedFrame, aContainedFrame);
+  aContainmentFrame->AppendFrames(kPrincipalList, contained);
+}
+
 void
 nsCSSFrameConstructor::FinishBuildingScrollFrame(nsContainerFrame* aScrollFrame,
                                                  nsIFrame* aScrolledFrame)
 {
   nsFrameList scrolled(aScrolledFrame, aScrolledFrame);
   aScrollFrame->AppendFrames(kPrincipalList, scrolled);
 }
 
@@ -4500,16 +4557,50 @@ nsCSSFrameConstructor::BuildScrollFrame(
                              false, aNewFrame);
 
   aScrolledFrame->SetStyleContextWithoutNotification(scrolledContentStyle);
   InitAndRestoreFrame(aState, aContent, aNewFrame, aScrolledFrame);
 
   FinishBuildingScrollFrame(aNewFrame, aScrolledFrame);
 }
 
+void
+nsCSSFrameConstructor::BuildContainment(nsFrameConstructorState& aState,
+                                        nsIContent*              aContent,
+                                        nsStyleContext*          aContentStyle,
+                                        nsIFrame*                aContainedFrame,
+                                        nsContainerFrame*        aParentFrame,
+                                        nsContainerFrame*&       aNewFrame)
+{
+  nsFrameItems anonymousItems;
+
+  nsRefPtr<nsStyleContext> contentStyle = aContentStyle;
+
+  if (!aNewFrame) {
+    aNewFrame = new (mPresShell)
+      nsContainmentFrame(contentStyle);
+    InitAndRestoreFrame(aState, aContent, aParentFrame, aNewFrame);
+  }
+
+  CreateAnonymousFrames(aState, aContent, aNewFrame, nullptr,
+                        anonymousItems);
+
+  nsStyleSet *styleSet = mPresShell->StyleSet();
+  nsRefPtr<nsStyleContext> containedChildStyle =
+    styleSet->ResolveAnonymousBoxStyle(nsCSSAnonBoxes::containment, contentStyle);
+
+  aNewFrame->SetInitialChildList(kPrincipalList, anonymousItems);
+
+  aContainedFrame->SetStyleContextWithoutNotification(containedChildStyle);
+  InitAndRestoreFrame(aState, aContent, aNewFrame, aContainedFrame);
+
+  nsFrameList contained(aContainedFrame, aContainedFrame);
+  aNewFrame->AppendFrames(kPrincipalList, contained);
+}
+
 const nsCSSFrameConstructor::FrameConstructionData*
 nsCSSFrameConstructor::FindDisplayData(const nsStyleDisplay* aDisplay,
                                        Element* aElement,
                                        nsIFrame* aParentFrame,
                                        nsStyleContext* aStyleContext)
 {
   PR_STATIC_ASSERT(eParentTypeCount < (1 << (32 - FCDATA_PARENT_TYPE_OFFSET)));
 
diff --git a/layout/base/nsCSSFrameConstructor.h b/layout/base/nsCSSFrameConstructor.h
--- a/layout/base/nsCSSFrameConstructor.h
+++ b/layout/base/nsCSSFrameConstructor.h
@@ -1615,16 +1615,35 @@ private:
   void
   BuildScrollFrame(nsFrameConstructorState& aState,
                    nsIContent*              aContent,
                    nsStyleContext*          aContentStyle,
                    nsIFrame*                aScrolledFrame,
                    nsContainerFrame*        aParentFrame,
                    nsContainerFrame*&       aNewFrame);
 
+  void
+  BuildContainment(nsFrameConstructorState& aState,
+                   nsIContent*              aContent,
+                   nsStyleContext*          aContentStyle,
+                   nsIFrame*                aContainedFrame,
+                   nsContainerFrame*        aParentFrame,
+                   nsContainerFrame*&       aNewFrame);
+
+  already_AddRefed<nsStyleContext>
+  BeginBuildingContainment(nsFrameConstructorState& aState,
+                           nsIContent*              aContent,
+                           nsStyleContext*          aContentStyle,
+                           nsContainerFrame*        aParentFrame,
+                           nsContainerFrame*&       aNewFrame);
+  void
+  FinishBuildingContainment(nsContainerFrame* aContainmentFrame,
+                            nsIFrame *aContainedFrame,
+                            nsRefPtr<nsStyleContext> &containedChildStyle);
+
   // Builds the initial ScrollFrame
   already_AddRefed<nsStyleContext>
   BeginBuildingScrollFrame(nsFrameConstructorState& aState,
                            nsIContent*              aContent,
                            nsStyleContext*          aContentStyle,
                            nsContainerFrame*        aParentFrame,
                            nsIAtom*                 aScrolledPseudo,
                            bool                     aIsRoot,
diff --git a/layout/generic/moz.build b/layout/generic/moz.build
--- a/layout/generic/moz.build
+++ b/layout/generic/moz.build
@@ -118,16 +118,17 @@ UNIFIED_SOURCES += [
     'nsBlockFrame.cpp',
     'nsBlockReflowContext.cpp',
     'nsBlockReflowState.cpp',
     'nsBRFrame.cpp',
     'nsBulletFrame.cpp',
     'nsCanvasFrame.cpp',
     'nsColumnSetFrame.cpp',
     'nsContainerFrame.cpp',
+    'nsContainmentFrame.cpp',
     'nsFirstLetterFrame.cpp',
     'nsFlexContainerFrame.cpp',
     'nsFloatManager.cpp',
     'nsFontInflationData.cpp',
     'nsFrame.cpp',
     'nsFrameList.cpp',
     'nsFrameSetFrame.cpp',
     'nsFrameState.cpp',
diff --git a/layout/generic/nsContainmentFrame.cpp b/layout/generic/nsContainmentFrame.cpp
new file mode 100644
--- /dev/null
+++ b/layout/generic/nsContainmentFrame.cpp
@@ -0,0 +1,36 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+
+#include "nsContainmentFrame.h"
+
+#include "nsFrameManager.h"
+#include "nsLayoutUtils.h"
+
+
+NS_IMPL_FRAMEARENA_HELPERS(nsContainmentFrame)
+
+#ifdef DEBUG
+NS_QUERYFRAME_HEAD(nsContainmentFrame)
+  NS_QUERYFRAME_ENTRY(nsContainmentFrame)
+NS_QUERYFRAME_TAIL_INHERITING(nsFrame)
+#endif
+
+#ifdef DEBUG_FRAME_DUMP
+nsresult
+nsContainmentFrame::GetFrameName(nsAString& aResult) const
+{
+  return MakeFrameName(NS_LITERAL_STRING("Containment"), aResult);
+}
+
+void
+nsContainmentFrame::List(FILE* out, const char* aPrefix, uint32_t aFlags) const
+{
+  nsCString str;
+  ListGeneric(str, aPrefix, aFlags);
+
+  fprintf_stderr(out, "%s\n", str.get());
+}
+#endif
diff --git a/layout/generic/nsContainmentFrame.h b/layout/generic/nsContainmentFrame.h
new file mode 100644
--- /dev/null
+++ b/layout/generic/nsContainmentFrame.h
@@ -0,0 +1,31 @@
+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+#ifndef nsContainmentFrame_h___
+#define nsContainmentFrame_h___
+
+//#include "mozilla/Attributes.h"
+#include "nsFrame.h"
+
+class nsContainmentFrame final : public nsContainerFrame {
+public:
+  NS_DECL_FRAMEARENA_HELPERS
+#ifdef DEBUG
+  NS_DECL_QUERYFRAME_TARGET(nsContainmentFrame)
+  NS_DECL_QUERYFRAME
+#endif
+
+  nsContainmentFrame(nsStyleContext* aContext)
+    : nsContainerFrame(aContext)
+  {
+  }
+
+#ifdef DEBUG_FRAME_DUMP
+  void List(FILE* out = stderr, const char* aPrefix = "", uint32_t aFlags = 0) const override;
+  virtual nsresult GetFrameName(nsAString& aResult) const override;
+#endif // DEBUG
+};
+
+#endif /* nsContainmentFrame_h___ */
diff --git a/layout/generic/nsFrameIdList.h b/layout/generic/nsFrameIdList.h
--- a/layout/generic/nsFrameIdList.h
+++ b/layout/generic/nsFrameIdList.h
@@ -11,16 +11,17 @@ FRAME_ID(nsBoxFrame)
 FRAME_ID(nsBulletFrame)
 FRAME_ID(nsButtonBoxFrame)
 FRAME_ID(nsCanvasFrame)
 FRAME_ID(nsColorControlFrame)
 FRAME_ID(nsColumnSetFrame)
 FRAME_ID(nsComboboxControlFrame)
 FRAME_ID(nsComboboxDisplayFrame)
 FRAME_ID(nsContainerFrame)
+FRAME_ID(nsContainmentFrame)
 FRAME_ID(nsContinuingTextFrame)
 FRAME_ID(nsDeckFrame)
 FRAME_ID(nsDocElementBoxFrame)
 FRAME_ID(nsFieldSetFrame)
 FRAME_ID(nsFileControlFrame)
 FRAME_ID(nsFirstLetterFrame)
 FRAME_ID(nsFirstLineFrame)
 FRAME_ID(nsFlexContainerFrame)
diff --git a/layout/reftests/css-contain/layout-zero.html b/layout/reftests/css-contain/layout-zero.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-contain/layout-zero.html
@@ -0,0 +1,29 @@
+
+<!DOCTYPE HTML>
+<html>
+<head>
+  <meta charset="utf-8">
+  <style>
+  body {
+    margin: 0;
+  }
+  .container {
+    contain: layout;
+    background: red;
+    border: 1em solid green;
+  }
+  </style>
+</head>
+<body class="reftest-paint">
+  <div class="fun">
+    <div class="container">
+      <div>
+  Lorem ipsum dolor sit amet, cu per agam quaerendum reprehendunt, scripta vivendo perfecto vis eu. Sea fastidii principes an. Sed in duis senserit, et cum impedit voluptaria, in nam sumo affert recteque. Sanctus suavitate voluptatibus te ius. Eos id insolens gloriatur repudiandae, vim in adhuc principes reprimique, vis ad omnium pericula reprimique.
+      </div>
+    </div>
+    <div>
+      This is some content after the contained element.
+    </div>
+  </div>
+</body>
+</html>
diff --git a/layout/style/nsCSSAnonBoxList.h b/layout/style/nsCSSAnonBoxList.h
--- a/layout/style/nsCSSAnonBoxList.h
+++ b/layout/style/nsCSSAnonBoxList.h
@@ -56,16 +56,17 @@ CSS_ANON_BOX(page, ":-moz-page")
 CSS_ANON_BOX(pageContent, ":-moz-pagecontent")
 CSS_ANON_BOX(pageSequence, ":-moz-page-sequence")
 CSS_ANON_BOX(scrolledContent, ":-moz-scrolled-content")
 CSS_ANON_BOX(scrolledCanvas, ":-moz-scrolled-canvas")
 CSS_ANON_BOX(scrolledPageSequence, ":-moz-scrolled-page-sequence")
 CSS_ANON_BOX(columnContent, ":-moz-column-content")
 CSS_ANON_BOX(viewport, ":-moz-viewport")
 CSS_ANON_BOX(viewportScroll, ":-moz-viewport-scroll")
+CSS_ANON_BOX(containment, ":-moz-containment")
 
 // Inside a flex container, a contiguous run of text gets wrapped in
 // an anonymous block, which is then treated as a flex item.
 CSS_ANON_BOX(anonymousFlexItem, ":-moz-anonymous-flex-item")
 
 // Inside a grid container, a contiguous run of text gets wrapped in
 // an anonymous block, which is then treated as a grid item.
 CSS_ANON_BOX(anonymousGridItem, ":-moz-anonymous-grid-item")
diff --git a/layout/style/nsCSSPseudoElementList.h b/layout/style/nsCSSPseudoElementList.h
--- a/layout/style/nsCSSPseudoElementList.h
+++ b/layout/style/nsCSSPseudoElementList.h
@@ -33,16 +33,19 @@ CSS_PSEUDO_ELEMENT(firstLetter, ":first-
                    CSS_PSEUDO_ELEMENT_CONTAINS_ELEMENTS)
 CSS_PSEUDO_ELEMENT(firstLine, ":first-line",
                    CSS_PSEUDO_ELEMENT_IS_CSS2 |
                    CSS_PSEUDO_ELEMENT_CONTAINS_ELEMENTS)
 
 CSS_PSEUDO_ELEMENT(mozSelection, ":-moz-selection",
                    CSS_PSEUDO_ELEMENT_CONTAINS_ELEMENTS)
 
+CSS_PSEUDO_ELEMENT(mozContainment, ":-moz-containment",
+                   CSS_PSEUDO_ELEMENT_CONTAINS_ELEMENTS)
+
 // XXXbz should we really allow random content to style these?  Maybe
 // use our flags to prevent that?
 CSS_PSEUDO_ELEMENT(mozFocusInner, ":-moz-focus-inner", 0)
 CSS_PSEUDO_ELEMENT(mozFocusOuter, ":-moz-focus-outer", 0)
 
 // XXXbz should we really allow random content to style these?  Maybe
 // use our flags to prevent that?
 CSS_PSEUDO_ELEMENT(mozListBullet, ":-moz-list-bullet", 0)
diff --git a/layout/style/nsStyleStruct.h b/layout/style/nsStyleStruct.h
--- a/layout/style/nsStyleStruct.h
+++ b/layout/style/nsStyleStruct.h
@@ -2233,16 +2233,20 @@ struct nsStyleDisplay {
     return mOverflowX != NS_STYLE_OVERFLOW_VISIBLE &&
            mOverflowX != NS_STYLE_OVERFLOW_CLIP;
   }
 
   bool IsStyleContaining() const {
     return NS_STYLE_CONTAIN_STYLE & mContain;
   }
 
+  bool IsLayoutContaining() const {
+    return NS_STYLE_CONTAIN_LAYOUT & mContain;
+  }
+
   /* Returns whether the element has the -moz-transform property
    * or a related property. */
   bool HasTransformStyle() const {
     return mSpecifiedTransform != nullptr ||
            mTransformStyle == NS_STYLE_TRANSFORM_STYLE_PRESERVE_3D ||
            (mWillChangeBitField & NS_STYLE_WILL_CHANGE_TRANSFORM);
   }
 
